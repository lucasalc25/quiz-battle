<!DOCTYPE html>
<html lang="pt-BR">
  <script>
    (function () {
      const saved = localStorage.getItem("theme");
      const preferred = saved ? saved : "dark";
      document.documentElement.setAttribute("data-theme", preferred);
    })();
  </script>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="turbo-cache-control" content="no-preview" />

    <title>{{ title or "Quiz Battle" }}</title>
    <link rel="stylesheet" href="../static/styles.css" />
    <script src="https://unpkg.com/@hotwired/turbo@8.0.4/dist/turbo.es2017-umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="{{ body_class or '' }}" data-page="{{ body_class or '' }}">
    <header id="header">
      <div class="theme-toggle" aria-label="Alternar tema">
        <span class="theme-label">‚òÄÔ∏è</span>
        <input id="themeChk" type="checkbox" aria-label="tema escuro" />
        <label for="themeChk" class="theme-switch"></label>
        <span class="theme-label">üåô</span>
      </div>

      <!-- Bot√£o de mute/unmute -->
      <button
        id="muteBtn"
        class="mute-btn"
        aria-label="Alternar som"
        data-turbo-permanent
      >
        <i data-lucide="volume-x"></i>
      </button>
    </header>

    <audio id="bgMusic" autoplay loop muted preload="auto" data-turbo-permanent>
      <source id="bgSource" src="" type="audio/mpeg" data-current="" />
    </audio>

    <main class="container">{% block content %}{% endblock %}</main>

    <script>
      (function () {
        const KEY_MUTED = "muted";

        function pageKind() {
          return document.body.dataset.page || ""; // "home" | "game" | "rank" | "end"
        }
        function urlFor(track) {
          return track === "home"
            ? "{{ url_for('static', filename='audio/home.mp3') }}"
            : "{{ url_for('static', filename='audio/game.mp3') }}";
        }
        function ensureElements() {
          const btn = document.getElementById("muteBtn");
          const audio = document.getElementById("bgMusic");
          const source = document.getElementById("bgSource");
          return { btn, audio, source };
        }
        function setIcon(btn, audio) {
          if (!btn) return;
          if (window.lucide) {
            btn.innerHTML = audio.muted
              ? '<i data-lucide="volume-x"></i>'
              : '<i data-lucide="volume-2"></i>';
            try {
              lucide.createIcons();
            } catch (_) {}
          } else {
            btn.textContent = audio.muted ? "üîá" : "üîä";
          }
        }

        // init √∫nico
        if (!window.__bgInit) {
          const { btn, audio } = ensureElements();
          const savedMute = localStorage.getItem(KEY_MUTED);
          audio.muted = savedMute === "1" || savedMute === null; // come√ßa mudo por padr√£o
          setIcon(btn, audio);

          if (!btn.dataset.bound) {
            btn.addEventListener("click", () => {
              audio.muted = !audio.muted;
              localStorage.setItem(KEY_MUTED, audio.muted ? "1" : "0");
              if (!audio.muted) audio.play().catch(() => {});
              setIcon(btn, audio);
            });
            btn.dataset.bound = "1";
          }

          // desbloqueia autoplay no primeiro clique
          document.addEventListener(
            "click",
            () => {
              if (!audio.muted && audio.paused) audio.play().catch(() => {});
            },
            { once: true }
          );

          window.__bgInit = true;
        }

        function onLoadPage() {
          if (document.documentElement.hasAttribute("data-turbo-preview"))
            return;

          const { audio, source, btn } = ensureElements();

          // Regra de trilha: home -> "home", game -> "game", rank/end -> mant√©m √∫ltima
          const kind = pageKind();
          const lastUrl = source.getAttribute("src") || ""; // URL atual
          const lastTrack = lastUrl.includes("/audio/game.mp3")
            ? "game"
            : lastUrl.includes("/audio/home.mp3")
            ? "home"
            : ""; // desconhecido (primeiro load)

          const wantedTrack =
            kind === "home"
              ? "home"
              : kind === "game"
              ? "game"
              : lastTrack || "home";

          const wantedUrl = urlFor(wantedTrack);

          // J√° estamos na trilha desejada? N√ÉO mexe em src/load (evita restart)
          // Use includes porque source.src vira URL absoluta
          if (
            lastUrl &&
            audio.querySelector("source").src.includes(wantedUrl)
          ) {
            if (!audio.muted && audio.paused) audio.play().catch(() => {});
            setIcon(btn, audio);
            return;
          }

          // Primeira defini√ß√£o ou troca real (home <-> game): agora sim troca src e load()
          source.setAttribute("src", wantedUrl);
          audio.load();
          audio.addEventListener(
            "loadedmetadata",
            () => {
              if (!audio.muted) audio.play().catch(() => {});
              setIcon(btn, audio);
            },
            { once: true }
          );
        }

        document.addEventListener("turbo:load", onLoadPage);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(onLoadPage, 0);
        }
      })();

      (function () {
        const chk = document.getElementById("themeChk");
        const current =
          document.documentElement.getAttribute("data-theme") || "dark";
        // marca o switch conforme o tema atual
        chk.checked = current === "dark";

        chk.addEventListener("change", () => {
          const next = chk.checked ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", next);
          localStorage.setItem("theme", next);
        });
      })();
    </script>
  </body>
</html>
