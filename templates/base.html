<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="turbo-cache-control" content="no-preview" />

    <title>{{ title or "Quiz Battle" }}</title>
    <link rel="stylesheet" href="../static/base.css" />
    <link rel="stylesheet" href="../static/login.css" />
    <link rel="stylesheet" href="../static/home.css" />
    <link rel="stylesheet" href="../static/game.css" />
    <link rel="stylesheet" href="../static/leaderboard.css" />

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@hotwired/turbo@8.0.4/dist/turbo.es2017-umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      (function () {
        const saved = localStorage.getItem("theme");
        const preferred = saved ? saved : "dark";
        document.documentElement.setAttribute("data-theme", preferred);
      })();

      /* Audio curto para a roleta ‚Äì sem lag */
      window.RouletteAudio = (function () {
        let ctx,
          buffer,
          preloadPromise = null;

        async function ensureContext() {
          if (!ctx)
            ctx = new (window.AudioContext || window.webkitAudioContext)();
          if (ctx.state === "suspended") {
            try {
              await ctx.resume();
            } catch (e) {}
          }
          return ctx;
        }

        async function preload(url) {
          if (buffer) return buffer;
          if (!preloadPromise) {
            preloadPromise = (async () => {
              const ctx = await ensureContext();
              const res = await fetch(url, { cache: "force-cache" });
              const arr = await res.arrayBuffer();
              buffer = await ctx.decodeAudioData(arr);
              return buffer;
            })();
          }
          return preloadPromise;
        }

        async function tick() {
          try {
            const ctx = await ensureContext();
            if (!buffer) return; // ainda n√£o carregou
            const src = ctx.createBufferSource();
            src.buffer = buffer;
            // levemente mais ‚Äúclique‚Äù:
            // src.playbackRate.value = 1.05;
            src.connect(ctx.destination);
            src.start();
          } catch (e) {}
        }

        return { preload, tick };
      })();
    </script>

    <script>
      document.addEventListener("turbo:load", () => {
        document.querySelectorAll('a[href^="/auth/"]').forEach((a) => {
          a.setAttribute("data-turbo", "false");
        });
        document.querySelectorAll('form[action^="/auth/"]').forEach((f) => {
          f.setAttribute("data-turbo", "false");
        });
      });

      document.addEventListener("turbo:before-visit", (e) => {
        try {
          const url = new URL(e.detail.url, window.location.origin);
          if (url.pathname.startsWith("/auth/")) {
            e.preventDefault();
            window.location.href = url.href; // navega√ß√£o hard
          }
        } catch (_) {}
      });

      // Como segunda camada, se algum link/form escapar:
      document.addEventListener("turbo:load", () => {
        document
          .querySelectorAll('a[href^="/auth/"]')
          .forEach((a) => a.setAttribute("data-turbo", "false"));
        document
          .querySelectorAll('form[action^="/auth/"]')
          .forEach((f) => f.setAttribute("data-turbo", "false"));
      });
    </script>

    <link
      rel="preload"
      as="audio"
      href="{{ url_for('static', filename='audio/tick.mp3') }}"
    />
    <link
      rel="preload"
      as="audio"
      href="{{ url_for('static', filename='audio/home.mp3') }}"
    />
    <link
      rel="preload"
      as="audio"
      href="{{ url_for('static', filename='audio/game.mp3') }}"
    />
  </head>

  <body class="{{ body_class or '' }}" data-page="{{ body_class or '' }}">
    {% if body_class != "maintenance" %}
    <header id="header">
      <div class="header-wrap">
        <!-- Logo -->
        <div class="logo-wrap">
          <a href="/"
            ><img
              src="../static/images/logo-quizzy2.png"
              width="120px"
              alt="Logo Quiz"
          /></a>
        </div>

        <div class="search-area">
          <form
            action="{{ url_for('home') }}"
            method="get"
            data-group="search-bar"
            class="search-bar"
          >
            <i data-lucide="search"></i>
            <input
              type="text"
              name="q"
              data-target="search-bar"
              placeholder="Buscar quizzes, membros ou t√≥picos"
              value="{{ request.args.get('q','') if request else '' }}"
              autocomplete="off"
            />
          </form>
        </div>

        <div class="search-btn-wrap">
          <button
            id="searchToggle"
            class="action-btn search-toggle"
            title="Buscar"
          >
            <i data-lucide="search"></i>
          </button>
        </div>

        <div class="header-actions">
          <nav class="primary-nav">
            <a href="{{ url_for('home') }}" class="nav-link">In√≠cio</a>
            <a href="{{ url_for('home') }}#ranking" class="nav-link">Ranking</a>
            <a href="{{ url_for('home') }}#criar" class="nav-link">Criar</a>
            <a href="{{ url_for('home') }}#explorar" class="nav-link"
              >Explorar</a
            >
          </nav>

          <!-- Bot√£o de Tema -->
          <button
            id="themeBtn"
            class="action-btn"
            title="Alternar tema"
            data-turbo-permanent
          >
            <i data-lucide="sun"></i>
          </button>

          <!-- Bot√£o de mute/unmute -->
          <button
            id="muteBtn"
            class="action-btn"
            aria-label="Alternar som"
            data-turbo-permanent
          >
            <i data-lucide="volume-x"></i>
          </button>

          <audio id="bgMusic" autoplay loop muted data-turbo-permanent>
            <source id="bgSource" src="" type="audio/mpeg" data-current="" />
          </audio>
        </div>

        <button
          id="notifyBtnMobile"
          class="action-btn notify-mobile"
          title="Notifica√ß√µes"
        >
          <i data-lucide="bell"></i>
        </button>

        <button
          id="mobileMenuBtn"
          class="action-btn hamburger"
          aria-label="Menu"
        >
          <i data-lucide="menu"></i>
        </button>

        {% if current_user.is_authenticated %}
        <button
          id="userMenuBtn"
          class="user-badge"
          type="button"
          aria-haspopup="true"
          aria-expanded="false"
          title="Abrir menu de usu√°rio"
          style="margin-left: 6px"
        >
          {% if current_user.avatar_url %}
          <img
            src="{{ current_user.avatar_url }}"
            alt="{{ current_user.nickname or current_user.email }}"
            referrerpolicy="no-referrer"
            style="pointer-events: none"
          />
          {% else %}
          <div class="user-placeholder">
            {{ (current_user.nickname or current_user.email or '?')[0]|upper }}
          </div>
          {% endif %}
          <i class="user-caret" data-lucide="chevron-down"></i>
        </button>
        {% endif %}
      </div>
    </header>

    <div id="searchPanel" class="search-panel">
      <form
        action="{{ url_for('home') }}"
        method="get"
        class="search-bar search-bar--panel"
      >
        <i data-lucide="search"></i>
        <input
          type="text"
          name="q"
          placeholder="Buscar quizzes, membros ou t√≥picos"
          value="{{ request.args.get('q','') if request else '' }}"
          autocomplete="off"
        />
      </form>
    </div>

    <!-- MENU MOBILE (dropdown) -->
    <div id="mobileMenu" class="mobile-menu" aria-hidden="true">
      <a class="menu-item" href="{{ url_for('home') }}"
        ><i data-lucide="home"></i><span>In√≠cio</span></a
      >
      <a class="menu-item" href="{{ url_for('home') }}#criar"
        ><i data-lucide="plus-circle"></i><span>Criar</span></a
      >
      <a class="menu-item" href="{{ url_for('home') }}#ranking"
        ><i data-lucide="trophy"></i><span>Ranking</span></a
      >
      <a class="menu-item" href="{{ url_for('home') }}#explorar"
        ><i data-lucide="compass"></i><span>Explorar</span></a
      >
      <hr />
      <button class="menu-item" data-action="notify">
        <i data-lucide="bell"></i><span>Notifica√ß√µes</span>
      </button>
      <button id="themeMenuBtn" class="menu-item" data-action="theme">
        <i data-lucide="sun"></i>
      </button>
      <button id="muteMenuBtn" class="menu-item" data-action="audio">
        <i data-lucide="volume-x"></i>
      </button>
    </div>

    <!-------- USER MENU (dropdown) -------->
    <div id="userMenu" class="user-menu" aria-hidden="true">
      <!-- Header do menu -->
      <div class="user-menu-head">
        <div class="user-menu-avatar">
          {% if current_user.avatar_url %}
          <img
            src="{{ current_user.avatar_url }}"
            alt="Foto de perfil"
            referrerpolicy="no-referrer"
          />
          {% else %}
          <div class="user-placeholder sm">
            {{ (current_user.nickname or current_user.email or '?')[0]|upper }}
          </div>
          {% endif %}

          <!-- Bot√£o/atalho para editar foto (ajuste a rota) -->
          <a href="{{ url_for('home') }}#editar-foto" class="edit-photo-btn">
            <i data-lucide="camera" style="width: 16px; height: 16px"></i>
          </a>
        </div>

        <div
          class="user-menu-greet"
          style="display: flex; align-items: center; justify-content: center"
        >
          <p class="hello">
            Ol√°,
            <a href="#" class="user-name-link">
              {{ current_user.nickname or current_user.email }}
            </a>
            üëã
          </p>
        </div>
      </div>

      <!-- Lista de op√ß√µes -->
      <nav class="user-menu-list">
        <a class="menu-item" href="{{ url_for('home') }}#perfil"
          ><i data-lucide="user"></i><span>Meu perfil</span></a
        >
        <a class="menu-item" href="{{ url_for('home') }}#pontuacoes"
          ><i data-lucide="target"></i><span>Minhas pontua√ß√µes</span></a
        >
        <a class="menu-item" href="{{ url_for('home') }}#favoritos"
          ><i data-lucide="star"></i><span>Meus favoritos</span></a
        >
        <a class="menu-item" href="{{ url_for('home') }}#notificacoes"
          ><i data-lucide="bell"></i><span>Notifica√ß√µes</span></a
        >
        <a class="menu-item" href="{{ url_for('home') }}#mensagens"
          ><i data-lucide="message-circle"></i><span>Mensagens</span></a
        >
        <a class="menu-item" href="{{ url_for('home') }}#config"
          ><i data-lucide="settings"></i><span>Configura√ß√µes</span></a
        >
        <hr />
        <!-- Sair (POST) -->
        <form
          method="post"
          action="{{ url_for('do_logout') }}"
          data-turbo="false"
        >
          <button type="submit" class="menu-item danger">
            <i data-lucide="log-out"></i><span>Sair</span>
          </button>
        </form>
      </nav>
    </div>

    <script>
      // ----------- BARRA DE PESQUISA EXPANS√çVEL ----------------
      (function () {
        function bindSearchToggle() {
          const btn = document.getElementById("searchToggle");
          const panel = document.getElementById("searchPanel");
          if (!btn || !panel) return;

          function openPanel() {
            panel.classList.add("open");
            // foco no input ao abrir
            const input = panel.querySelector('input[name="q"]');
            setTimeout(() => input && input.focus(), 10);
          }
          function closePanel() {
            panel.classList.remove("open");
          }

          // toggle
          if (!btn.dataset.bound) {
            btn.addEventListener("click", (e) => {
              e.preventDefault();
              panel.classList.contains("open") ? closePanel() : openPanel();
            });
            btn.dataset.bound = "1";
          }

          // fechar ao clicar fora
          document.addEventListener("click", (e) => {
            if (!panel.classList.contains("open")) return;
            const withinPanel =
              panel.contains(e.target) || btn.contains(e.target);
            if (!withinPanel) closePanel();
          });

          // ESC fecha
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closePanel();
          });

          // navegar (Turbo) fecha
          document.addEventListener("turbo:before-visit", closePanel);

          // re-render √≠cones lucide se necess√°rio
          if (window.lucide)
            try {
              lucide.createIcons();
            } catch (_) {}
        }

        document.addEventListener("turbo:load", bindSearchToggle);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(bindSearchToggle, 0);
        }
      })();

      // ----------- MENU MOBILE EXPANS√çVEL ----------------
      (function () {
        function bindMobileMenu() {
          const btn = document.getElementById("mobileMenuBtn");
          const menu = document.getElementById("mobileMenu");
          if (!btn || !menu) return;

          const notifyBtn = document.getElementById("notifyBtn");
          const themeBtn = document.getElementById("themeBtn");
          const audioBtn = document.getElementById("muteBtn");

          function paintIcons() {
            if (window.lucide)
              try {
                lucide.createIcons();
              } catch (_) {}
          }

          // === NOVO: √≠cone do hamb√∫rguer ===
          function setHamburger(open) {
            btn.innerHTML = open
              ? '<i data-lucide="x"></i>'
              : '<i data-lucide="menu"></i>';
            paintIcons();
          }

          function openMenu() {
            menu.classList.add("open");
            menu.setAttribute("aria-hidden", "false");
            setHamburger(true);
            if (window.__syncThemeIcon) window.__syncThemeIcon();
            if (window.__syncAudioIcon) window.__syncAudioIcon();
          }
          function closeMenu() {
            menu.classList.remove("open");
            menu.setAttribute("aria-hidden", "true");
            setHamburger(false);
          }
          function toggleMenu(e) {
            e.preventDefault();
            menu.classList.contains("open") ? closeMenu() : openMenu();
          }

          if (!btn.dataset.bound) {
            btn.addEventListener("click", toggleMenu);
            btn.dataset.bound = "1";
          }

          // clique fora fecha
          document.addEventListener("click", (e) => {
            if (!menu.classList.contains("open")) return;
            const inside = menu.contains(e.target) || btn.contains(e.target);
            if (!inside) closeMenu();
          });

          // a√ß√µes do menu disparam bot√µes originais
          menu.querySelectorAll(".menu-item[data-action]").forEach((el) => {
            el.addEventListener("click", (e) => {
              const act = el.getAttribute("data-action");
              if (act === "notify" && notifyBtn) notifyBtn.click();
              if (act === "theme" && themeBtn) themeBtn.click();
              if (act === "audio" && audioBtn) audioBtn.click();
              closeMenu();
            });
          });

          document.addEventListener("turbo:before-visit", closeMenu);

          paintIcons();
        }

        document.addEventListener("turbo:load", bindMobileMenu);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(bindMobileMenu, 0);
        }
      })();

      (function () {
        // Utilit√°rio: re-render dos √≠cones Lucide ap√≥s alterar o HTML
        function paintIcons() {
          if (window.lucide)
            try {
              lucide.createIcons();
            } catch (_) {}
        }

        // === THEME ICON (sun/moon) ===
        function getTheme() {
          return localStorage.getItem("theme") || "dark";
        }
        function setThemeIcon(theme) {
          const themeBtn = document.getElementById("themeBtn");
          if (themeBtn) {
            // regra: light => moon ; dark => sun
            themeBtn.innerHTML =
              theme === "light"
                ? '<i data-lucide="moon"></i>'
                : '<i data-lucide="sun"></i>';
          }

          const mobileItemIcon = document.querySelector("#themeMenuBtn");
          if (mobileItemIcon) {
            mobileItemIcon.innerHTML =
              theme === "light"
                ? '<i data-lucide="moon"></i><span>Tema</span>'
                : '<i data-lucide="sun"></i><span>Tema</span>';
          }
          paintIcons();
        }

        // j√° existe seu controle de tema; s√≥ pluga o √≠cone
        document.addEventListener("turbo:load", () => setThemeIcon(getTheme()));

        // Se seu c√≥digo de tema trocar o localStorage, chame setThemeIcon(newTheme) l√° tamb√©m.
        // Exemplo (se quiser amarrar aqui):
        const themeBtn = document.getElementById("themeBtn");
        if (themeBtn && !themeBtn.dataset.bound) {
          themeBtn.addEventListener("click", () => {
            const now = getTheme() === "dark" ? "light" : "dark";
            localStorage.setItem("theme", now);
            document.documentElement.dataset.theme = now;
            setThemeIcon(now);
          });
          themeBtn.dataset.bound = "1";
        }

        // === AUDIO ICON (mute/unmute) ===
        function setAudioIcon() {
          const btn = document.getElementById("muteBtn");
          const audio = document.getElementById("bgMusic");
          if (btn || audio) {
            // regra: desmutado => volume-2 ; mutado => volume-x
            btn.innerHTML = audio.muted
              ? '<i data-lucide="volume-x"></i>'
              : '<i data-lucide="volume-2"></i>';
          }

          const mobileItemIcon = document.querySelector("#muteMenuBtn");
          if (mobileItemIcon || audio) {
            mobileItemIcon.innerHTML = audio.muted
              ? '<i data-lucide="volume-x"></i><span>√Åudio</span>'
              : '<i data-lucide="volume-2"></i><span>√Åudio</span>';
          }
          paintIcons();
        }
        // Observa mudan√ßas de mute
        const audio = document.getElementById("bgMusic");
        if (audio) {
          audio.addEventListener("volumechange", setAudioIcon);
          // alguns navegadores n√£o disparam 'volumechange' para 'muted', ent√£o:
          setInterval(setAudioIcon, 600);
        }
        // E amarra o clique do bot√£o
        const muteBtn = document.getElementById("muteBtn");
        if (muteBtn && audio && !muteBtn.dataset.bound) {
          muteBtn.addEventListener("click", () => {
            audio.muted = !audio.muted;
            localStorage.setItem("muted", audio.muted ? "1" : "0");
            if (!audio.muted) audio.play().catch(() => {});
            setAudioIcon();
          });
          muteBtn.dataset.bound = "1";
        }
        document.addEventListener("turbo:load", setAudioIcon);

        // === NOTIFICA√á√ïES: bot√£o mobile dispara o desktop ===
        const notifyBtn = document.getElementById("notifyBtn"); // header (desktop)
        const notifyBtnMobile = document.getElementById("notifyBtnMobile"); // novo (mobile)
        if (notifyBtn && notifyBtnMobile && !notifyBtnMobile.dataset.bound) {
          notifyBtnMobile.addEventListener("click", (e) => {
            e.preventDefault();
            // dispare a mesma a√ß√£o do desktop (ex.: abrir dropdown/notifica√ß√µes)
            notifyBtn.click();
          });
          notifyBtnMobile.dataset.bound = "1";
        }

        // Re-pinta √≠cones lucide no load inicial
        document.addEventListener("turbo:load", paintIcons);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(paintIcons, 0);
        }
      })();

      // ----------- CONTROLE DE AUDIO ----------------
      (function () {
        // ==== chaves de storage ====
        const KEY_TRACK = "bg_track"; // "home" | "game"
        const KEY_POS = "bg_pos"; // segundos
        const KEY_MUTED = "muted"; // "1" | "0"

        // ==== helpers ====
        function ensureElements() {
          // garante que bot√£o, audio e source existem; cria se necess√°rio
          let btn = document.getElementById("muteBtn");
          let audio = document.getElementById("bgMusic");
          let source = document.getElementById("bgSource");

          return { btn, audio, source };
        }

        function urlFor(track) {
          // ajuste os caminhos conforme seus arquivos reais
          if (track === "home")
            return "{{ url_for('static', filename='audio/home.mp3') }}";
          return "{{ url_for('static', filename='audio/game.mp3') }}";
        }

        function pageKind() {
          return document.body.dataset.page || ""; // "home" | "game" | "rank" | "end"
        }

        function setIcon(btn, audio) {
          if (!btn) return;
          if (window.lucide) {
            btn.innerHTML = audio.muted
              ? '<i data-lucide="volume-x"></i>'
              : '<i data-lucide="volume-2"></i>';
            try {
              lucide.createIcons();
            } catch (_) {}
          } else {
            btn.textContent = audio.muted ? "üîá" : "üîä";
          }
        }

        // ==== inicializa√ß√£o √∫nica (para eventos persistentes) ====
        if (!window.__bgAudioInit) {
          const { btn, audio, source } = ensureElements();

          // estado de mute inicial (padr√£o: silenciado)
          const savedMute = localStorage.getItem(KEY_MUTED);
          audio.muted = savedMute === "1" || savedMute === null;
          setIcon(btn, audio);

          // bot√£o mute ‚Üí alterna e persiste
          if (!btn.dataset.bound) {
            btn.addEventListener("click", () => {
              audio.muted = !audio.muted;
              localStorage.setItem(KEY_MUTED, audio.muted ? "1" : "0");
              if (!audio.muted) audio.play().catch(() => {});
              setIcon(btn, audio);
            });
            btn.dataset.bound = "1";
          }

          // salvar posi√ß√£o periodicamente
          let saveTimer = null;
          function savePos() {
            try {
              localStorage.setItem(KEY_POS, String(audio.currentTime || 0));
              localStorage.setItem(
                KEY_TRACK,
                source.getAttribute("data-current") || "home"
              );
            } catch (_) {}
          }
          audio.addEventListener("play", () => {
            if (saveTimer) clearInterval(saveTimer);
            saveTimer = setInterval(savePos, 800);
          });
          audio.addEventListener("pause", () => {
            if (saveTimer) clearInterval(saveTimer);
            savePos();
          });
          window.addEventListener("pagehide", savePos);
          window.addEventListener("beforeunload", savePos);

          // desbloqueio de autoplay: 1¬∫ clique global
          document.addEventListener(
            "click",
            () => {
              if (!audio.muted && audio.paused) audio.play().catch(() => {});
            },
            { once: true }
          );

          window.__bgAudioInit = true;
        }

        // ==== handler de cada ‚Äúp√°gina‚Äù (Turbo) ====
        function onLoadPage() {
          // evita rodar durante preview
          if (document.documentElement.hasAttribute("data-turbo-preview"))
            return;

          const { audio, source, btn } = ensureElements();

          const bodyPage = pageKind();
          const lastTrack = localStorage.getItem(KEY_TRACK) || "home";

          // Regra:
          // - home ‚Üí "home"
          // - game ‚Üí "game"
          // - rank/end ‚Üí herdam a √∫ltima ("home" ou "game")
          let wanted;
          if (bodyPage === "home") wanted = "home";
          else if (bodyPage === "game") wanted = "game";
          else wanted = lastTrack || "home";

          const currentTrack = source.getAttribute("data-current") || "";
          const wantedTrack = wanted;

          // Trilha j√° correta? N√£o troque (evita qualquer micro-pausa)
          if (currentTrack === wantedTrack) {
            if (!audio.muted && audio.paused) audio.play().catch(() => {});
            setIcon(btn, audio);
            return;
          }

          // Troca de trilha: define src e, se herdou, tenta retomar posi√ß√£o
          const savedPos = parseFloat(localStorage.getItem(KEY_POS) || "0");
          const canResume = lastTrack === wantedTrack && savedPos > 0.2;

          source.src = urlFor(wantedTrack);
          source.setAttribute("data-current", wantedTrack);
          audio.load();

          audio.addEventListener(
            "loadedmetadata",
            () => {
              if (canResume && savedPos < (audio.duration || Infinity)) {
                try {
                  audio.currentTime = savedPos;
                } catch (_) {}
              }
              if (!audio.muted) audio.play().catch(() => {});
            },
            { once: true }
          );

          setIcon(btn, audio);
        }

        // eventos Turbo
        document.addEventListener("turbo:load", onLoadPage);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(onLoadPage, 0);
        }
      })();

      (function () {
        const btn = document.getElementById("userMenuBtn");
        const menu = document.getElementById("userMenu");
        const header = document.querySelector("#header");

        menu.style.top = header.offsetHeight + "px";

        if (!btn || !menu) return;

        function paintIcons() {
          if (window.lucide)
            try {
              lucide.createIcons();
            } catch (_) {}
        }

        function setArrow(open) {
          btn.innerHTML = open
            ? `{% if current_user.avatar_url %}
          <img
            src="{{ current_user.avatar_url }}"
            alt="{{ current_user.nickname or current_user.email }}"
            referrerpolicy="no-referrer"
            style="pointer-events: none"
          />
          {% else %}
          <div class="user-placeholder">
            {{ (current_user.nickname or current_user.email or '?')[0]|upper }}
          </div>
          {% endif %}
          <i class="user-caret" data-lucide="chevron-up"></i>`
            : `{% if current_user.avatar_url %}
          <img
            src="{{ current_user.avatar_url }}"
            alt="{{ current_user.nickname or current_user.email }}"
            referrerpolicy="no-referrer"
            style="pointer-events: none"
          />
          {% else %}
          <div class="user-placeholder">
            {{ (current_user.nickname or current_user.email or '?')[0]|upper }}
          </div>
          {% endif %}
          <i class="user-caret" data-lucide="chevron-down"></i>`;
          paintIcons();
        }

        function openMenu() {
          menu.classList.add("open");
          menu.setAttribute("aria-hidden", "false");
          btn.setAttribute("aria-expanded", "true");
          setArrow(true);
        }
        function closeMenu() {
          menu.classList.remove("open");
          menu.setAttribute("aria-hidden", "true");
          btn.setAttribute("aria-expanded", "false");
          setArrow(false);
        }
        function toggleMenu(e) {
          e && e.preventDefault();
          menu.classList.contains("open") ? closeMenu() : openMenu();
        }

        if (!btn.dataset.bound) {
          btn.addEventListener("click", toggleMenu);
          btn.dataset.bound = "1";
        }

        // Fechar com clique fora
        document.addEventListener("click", (e) => {
          if (!menu.classList.contains("open")) return;
          const hitBtn = btn.contains(e.target);
          const hitMenu = menu.contains(e.target);
          if (!hitBtn && !hitMenu) closeMenu();
        });

        // Fechar com ESC e ao navegar
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeMenu();
        });
        document.addEventListener("turbo:before-visit", closeMenu);

        // Re-render dos √≠cones ao carregar
        document.addEventListener("turbo:load", paintIcons);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(paintIcons, 0);
        }
      })();
    </script>
    {% endif %}

    <main class="container">{% block content %}{% endblock %}</main>
  </body>
</html>
