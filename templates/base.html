<!DOCTYPE html>
<html lang="pt-BR">
  <script>
    (function () {
      const saved = localStorage.getItem("theme");
      const preferred = saved ? saved : "dark";
      document.documentElement.setAttribute("data-theme", preferred);
    })();
  </script>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="turbo-cache-control" content="no-preview" />

    <title>{{ title or "Quiz Battle" }}</title>
    <link rel="stylesheet" href="../static/styles.css" />
    <script src="https://unpkg.com/@hotwired/turbo@8.0.4/dist/turbo.es2017-umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="{{ body_class or '' }}" data-page="{{ body_class or '' }}">
    <header id="header">
      <div class="theme-toggle" aria-label="Alternar tema">
        <span class="theme-label">‚òÄÔ∏è</span>
        <input id="themeChk" type="checkbox" aria-label="tema escuro" />
        <label for="themeChk" class="theme-switch"></label>
        <span class="theme-label">üåô</span>
      </div>

      <!-- Bot√£o de mute/unmute -->
      <button
        id="muteBtn"
        class="mute-btn"
        aria-label="Alternar som"
        data-turbo-permanent
      >
        <i data-lucide="volume-x"></i>
      </button>
    </header>

    <audio
      id="bgMusic"
      autoplay
      loop
      muted
      preload="auto"
      playsinline
      data-turbo-permanent
    >
      <source id="bgSource" src="" type="audio/mpeg" data-current="" />
    </audio>

    <main class="container">{% block content %}{% endblock %}</main>

    <script>
      (function () {
        const KEY_MUTED = "muted";

        function pageKind() {
          return document.body.dataset.page || ""; // "home" | "game" | "rank" | "end"
        }

        function urlFor(track) {
          return track === "home"
            ? "{{ url_for('static', filename='audio/home.mp3') }}"
            : "{{ url_for('static', filename='audio/game.mp3') }}";
        }

        function ensureElements() {
          const btn = document.getElementById("muteBtn");
          const audio = document.getElementById("bgMusic");
          const source = document.getElementById("bgSource");
          return { btn, audio, source };
        }

        async function resumeAudio(reason = "") {
          const { audio } = ensureElements();
          if (!audio || audio.muted) return;

          // tente algumas vezes com pequenos atrasos (caso o DOM ainda esteja estabilizando)
          for (let i = 0; i < 3; i++) {
            try {
              if (audio.paused) {
                // uma pequena espera ajuda ap√≥s o turbo:load
                await new Promise((r) => setTimeout(r, i === 0 ? 0 : 120));
                await audio.play();
              }
              break; // sucesso
            } catch (e) {
              // se bloqueou, tenta no pr√≥ximo loop
            }
          }
        }

        // === inicializa√ß√£o √∫nica (voc√™ j√° tem algo parecido) ===
        if (!window.__bgInit2) {
          const { btn, audio } = ensureElements();

          // come√ßa mutado (pol√≠tica de autoplay)
          const savedMute = localStorage.getItem("muted");
          audio.muted = savedMute === "1" || savedMute === null;

          // clique no bot√£o = gesto de usu√°rio ‚Üí depois disso o play() tende a ser liberado
          if (!btn.dataset.bound2) {
            btn.addEventListener("click", async () => {
              const wasMuted = audio.muted;
              audio.muted = !audio.muted;
              localStorage.setItem("muted", audio.muted ? "1" : "0");
              if (wasMuted && !audio.muted) {
                // gesto de usu√°rio: j√° tenta tocar agora
                try {
                  await audio.play();
                } catch (_) {}
              }
            });
            btn.dataset.bound2 = "1";
          }

          // 1¬∫ clique em qualquer lugar tamb√©m destrava
          document.addEventListener(
            "pointerdown",
            () => resumeAudio("pointerdown"),
            { once: true }
          );

          // === eventos amarrados a navega√ß√£o/visibilidade ===
          // Clique que inicia a navega√ß√£o Turbo (tem gesto de usu√°rio)
          document.addEventListener("turbo:click", () => {
            // tenta manter tocando durante a transi√ß√£o
            resumeAudio("turbo:click");
          });

          // Antes de visitar (ainda dentro do gesto)
          document.addEventListener("turbo:before-visit", () => {
            resumeAudio("turbo:before-visit");
          });

          // Ao carregar a nova p√°gina
          document.addEventListener("turbo:load", () => {
            // tenta j√° no mesmo frame‚Ä¶
            resumeAudio("turbo:load");
            // ‚Ä¶e mais uma vez no pr√≥ximo frame, caso o DOM ainda esteja assentando
            requestAnimationFrame(() => resumeAudio("raf-after-load"));
          });

          // Quando a aba volta a ficar vis√≠vel
          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
              resumeAudio("visibilitychange");
            }
          });

          // Navega√ß√£o do hist√≥rico / page show (Safari/iOS)
          window.addEventListener("pageshow", () => {
            resumeAudio("pageshow");
          });

          window.__bgInit2 = true;
        }

        function onLoadPage() {
          if (document.documentElement.hasAttribute("data-turbo-preview"))
            return;

          const { audio, source, btn } = ensureElements();

          // Decide trilha desejada
          const kind = pageKind();
          const lastUrl = source.getAttribute("src") || ""; // URL *relativa* que voc√™ setou
          const lastTrack = lastUrl.includes("/audio/game.mp3")
            ? "game"
            : lastUrl.includes("/audio/home.mp3")
            ? "home"
            : ""; // primeiro load

          const wantedTrack =
            kind === "home"
              ? "home"
              : kind === "game"
              ? "game"
              : lastTrack || "home";

          const wantedUrl = urlFor(wantedTrack);

          // J√° estamos na trilha desejada? N√ÉO mexe no src nem d√° load()
          // Use includes no "src absoluto" do <source> para comparar com a URL gerada
          const absoluteSrc = source.src || "";
          if (absoluteSrc && absoluteSrc.includes(wantedUrl)) {
            if (!audio.muted && audio.paused) resumeAudio("same-track");
            setIcon(btn, audio);
            return;
          }

          // Primeira defini√ß√£o ou troca real (home <-> game)
          source.setAttribute("src", wantedUrl);
          audio.load();
          audio.addEventListener(
            "loadedmetadata",
            () => {
              resumeAudio("changed-track");
              setIcon(btn, audio);
            },
            { once: true }
          );
        }

        // listeners
        document.addEventListener("turbo:load", onLoadPage);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(onLoadPage, 0);
        }
      })();

      (function () {
        const chk = document.getElementById("themeChk");
        const current =
          document.documentElement.getAttribute("data-theme") || "dark";
        // marca o switch conforme o tema atual
        chk.checked = current === "dark";

        chk.addEventListener("change", () => {
          const next = chk.checked ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", next);
          localStorage.setItem("theme", next);
        });
      })();
    </script>
  </body>
</html>
