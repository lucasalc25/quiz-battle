<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="turbo-cache-control" content="no-preview" />

    <title>{{ title or "Quiz Battle" }}</title>
    <link rel="stylesheet" href="../static/styles.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@hotwired/turbo@8.0.4/dist/turbo.es2017-umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      (function () {
        const saved = localStorage.getItem("theme");
        const preferred = saved ? saved : "dark";
        document.documentElement.setAttribute("data-theme", preferred);
      })();

      /* Audio curto para a roleta ‚Äì sem lag */
      window.RouletteAudio = (function () {
        let ctx,
          buffer,
          preloadPromise = null;

        async function ensureContext() {
          if (!ctx)
            ctx = new (window.AudioContext || window.webkitAudioContext)();
          if (ctx.state === "suspended") {
            try {
              await ctx.resume();
            } catch (e) {}
          }
          return ctx;
        }

        async function preload(url) {
          if (buffer) return buffer;
          if (!preloadPromise) {
            preloadPromise = (async () => {
              const ctx = await ensureContext();
              const res = await fetch(url, { cache: "force-cache" });
              const arr = await res.arrayBuffer();
              buffer = await ctx.decodeAudioData(arr);
              return buffer;
            })();
          }
          return preloadPromise;
        }

        async function tick() {
          try {
            const ctx = await ensureContext();
            if (!buffer) return; // ainda n√£o carregou
            const src = ctx.createBufferSource();
            src.buffer = buffer;
            // levemente mais ‚Äúclique‚Äù:
            // src.playbackRate.value = 1.05;
            src.connect(ctx.destination);
            src.start();
          } catch (e) {}
        }

        return { preload, tick };
      })();
    </script>

    <script>
      document.addEventListener("turbo:load", () => {
        document.querySelectorAll('a[href^="/auth/"]').forEach((a) => {
          a.setAttribute("data-turbo", "false");
        });
        document.querySelectorAll('form[action^="/auth/"]').forEach((f) => {
          f.setAttribute("data-turbo", "false");
        });
      });

      document.addEventListener("turbo:before-visit", (e) => {
        try {
          const url = new URL(e.detail.url, window.location.origin);
          if (url.pathname.startsWith("/auth/")) {
            e.preventDefault();
            window.location.href = url.href; // navega√ß√£o hard
          }
        } catch (_) {}
      });

      // Como segunda camada, se algum link/form escapar:
      document.addEventListener("turbo:load", () => {
        document
          .querySelectorAll('a[href^="/auth/"]')
          .forEach((a) => a.setAttribute("data-turbo", "false"));
        document
          .querySelectorAll('form[action^="/auth/"]')
          .forEach((f) => f.setAttribute("data-turbo", "false"));
      });
    </script>

    <link
      rel="preload"
      as="audio"
      href="{{ url_for('static', filename='audio/tick.mp3') }}"
    />
    <link
      rel="preload"
      as="audio"
      href="{{ url_for('static', filename='audio/home.mp3') }}"
    />
    <link
      rel="preload"
      as="audio"
      href="{{ url_for('static', filename='audio/game.mp3') }}"
    />
  </head>

  <body class="{{ body_class or '' }}" data-page="{{ body_class or '' }}">
    {% if body_class != "maintenance" %}
    <header id="header">
      <!-- Estado de conta -->
      <div class="left-header">
        <div
          class="account"
          style="
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          {% if current_user.is_authenticated %}
          <span class="muted"
            >Ol√°, <strong>{{ current_user.nickname }}</strong></span
          >
          <form method="post" action="{{ url_for('do_logout') }}">
            <button class="button" style="padding: 6px 15px; font-size: 0.9rem">
              Sair
            </button>
          </form>
          {% else %}
          <a
            class="button"
            href="{{ url_for('login') }}"
            style="padding: 8px 15px; font-size: 0.9rem"
            >Entrar</a
          >
          {% endif %}
        </div>
      </div>

      <div class="right-header">
        <button
          id="themeBtn"
          class="theme-btn"
          title="Alternar tema"
          data-turbo-permanent
        >
          <i data-lucide="sun"></i>
        </button>

        <!-- Bot√£o de mute/unmute -->
        <button
          id="muteBtn"
          class="mute-btn"
          aria-label="Alternar som"
          data-turbo-permanent
        >
          <i data-lucide="volume-x"></i>
        </button>

        <audio id="bgMusic" autoplay loop muted data-turbo-permanent>
          <source id="bgSource" src="" type="audio/mpeg" data-current="" />
        </audio>

        <!-- Bot√£o de novidades (sino) -->
        <button
          id="whatsNewBtn"
          class="news-btn"
          title="Novidades"
          data-turbo-permanent
        >
          <i data-lucide="bell"></i>
        </button>
      </div>
    </header>

    <script>
      // ----------- CONTROLE DE AUDIO ----------------
      (function () {
        // ==== chaves de storage ====
        const KEY_TRACK = "bg_track"; // "home" | "game"
        const KEY_POS = "bg_pos"; // segundos
        const KEY_MUTED = "muted"; // "1" | "0"

        // ==== helpers ====
        function ensureElements() {
          // garante que bot√£o, audio e source existem; cria se necess√°rio
          let btn = document.getElementById("muteBtn");
          let audio = document.getElementById("bgMusic");
          let source = document.getElementById("bgSource");

          return { btn, audio, source };
        }

        function urlFor(track) {
          // ajuste os caminhos conforme seus arquivos reais
          if (track === "home")
            return "{{ url_for('static', filename='audio/home.mp3') }}";
          return "{{ url_for('static', filename='audio/game.mp3') }}";
        }

        function pageKind() {
          return document.body.dataset.page || ""; // "home" | "game" | "rank" | "end"
        }

        function setIcon(btn, audio) {
          if (!btn) return;
          if (window.lucide) {
            btn.innerHTML = audio.muted
              ? '<i data-lucide="volume-x"></i>'
              : '<i data-lucide="volume-2"></i>';
            try {
              lucide.createIcons();
            } catch (_) {}
          } else {
            btn.textContent = audio.muted ? "üîá" : "üîä";
          }
        }

        // ==== inicializa√ß√£o √∫nica (para eventos persistentes) ====
        if (!window.__bgAudioInit) {
          const { btn, audio, source } = ensureElements();

          // estado de mute inicial (padr√£o: silenciado)
          const savedMute = localStorage.getItem(KEY_MUTED);
          audio.muted = savedMute === "1" || savedMute === null;
          setIcon(btn, audio);

          // bot√£o mute ‚Üí alterna e persiste
          if (!btn.dataset.bound) {
            btn.addEventListener("click", () => {
              audio.muted = !audio.muted;
              localStorage.setItem(KEY_MUTED, audio.muted ? "1" : "0");
              if (!audio.muted) audio.play().catch(() => {});
              setIcon(btn, audio);
            });
            btn.dataset.bound = "1";
          }

          // salvar posi√ß√£o periodicamente
          let saveTimer = null;
          function savePos() {
            try {
              localStorage.setItem(KEY_POS, String(audio.currentTime || 0));
              localStorage.setItem(
                KEY_TRACK,
                source.getAttribute("data-current") || "home"
              );
            } catch (_) {}
          }
          audio.addEventListener("play", () => {
            if (saveTimer) clearInterval(saveTimer);
            saveTimer = setInterval(savePos, 800);
          });
          audio.addEventListener("pause", () => {
            if (saveTimer) clearInterval(saveTimer);
            savePos();
          });
          window.addEventListener("pagehide", savePos);
          window.addEventListener("beforeunload", savePos);

          // desbloqueio de autoplay: 1¬∫ clique global
          document.addEventListener(
            "click",
            () => {
              if (!audio.muted && audio.paused) audio.play().catch(() => {});
            },
            { once: true }
          );

          window.__bgAudioInit = true;
        }

        // ==== handler de cada ‚Äúp√°gina‚Äù (Turbo) ====
        function onLoadPage() {
          // evita rodar durante preview
          if (document.documentElement.hasAttribute("data-turbo-preview"))
            return;

          const { audio, source, btn } = ensureElements();

          const bodyPage = pageKind();
          const lastTrack = localStorage.getItem(KEY_TRACK) || "home";

          // Regra:
          // - home ‚Üí "home"
          // - game ‚Üí "game"
          // - rank/end ‚Üí herdam a √∫ltima ("home" ou "game")
          let wanted;
          if (bodyPage === "home") wanted = "home";
          else if (bodyPage === "game") wanted = "game";
          else wanted = lastTrack || "home";

          const currentTrack = source.getAttribute("data-current") || "";
          const wantedTrack = wanted;

          // Trilha j√° correta? N√£o troque (evita qualquer micro-pausa)
          if (currentTrack === wantedTrack) {
            if (!audio.muted && audio.paused) audio.play().catch(() => {});
            setIcon(btn, audio);
            return;
          }

          // Troca de trilha: define src e, se herdou, tenta retomar posi√ß√£o
          const savedPos = parseFloat(localStorage.getItem(KEY_POS) || "0");
          const canResume = lastTrack === wantedTrack && savedPos > 0.2;

          source.src = urlFor(wantedTrack);
          source.setAttribute("data-current", wantedTrack);
          audio.load();

          audio.addEventListener(
            "loadedmetadata",
            () => {
              if (canResume && savedPos < (audio.duration || Infinity)) {
                try {
                  audio.currentTime = savedPos;
                } catch (_) {}
              }
              if (!audio.muted) audio.play().catch(() => {});
            },
            { once: true }
          );

          setIcon(btn, audio);
        }

        // eventos Turbo
        document.addEventListener("turbo:load", onLoadPage);
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(onLoadPage, 0);
        }
      })();

      // ----------- CONTROLE DE TEMAS ----------------
      (function () {
        const KEY = "theme";
        const btn = document.getElementById("themeBtn");

        function getTheme() {
          return localStorage.getItem(KEY) || "dark"; // seu padr√£o
        }
        function setTheme(t) {
          document.documentElement.dataset.theme = t; // adapte se usa outra mec√¢nica
          localStorage.setItem(KEY, t);

          // troca de √≠cone ao estilo do bot√£o de √°udio
          if (!btn) return;
          if (window.lucide) {
            btn.innerHTML =
              t === "dark"
                ? '<i data-lucide="sun"></i>'
                : '<i data-lucide="moon"></i>';
            try {
              lucide.createIcons();
            } catch (_) {}
          } else {
            btn.textContent = t === "dark" ? "üåô" : "‚òÄÔ∏è";
          }
        }
        function toggleTheme() {
          setTheme(getTheme() === "dark" ? "light" : "dark");
        }

        document.addEventListener("turbo:load", () => {
          setTheme(getTheme()); // pinta o √≠cone correto ao carregar
          if (btn && !btn.dataset.bound) {
            btn.addEventListener("click", toggleTheme);
            btn.dataset.bound = "1";
          }
        });
      })();
    </script>
    {% endif %}

    <main class="container">{% block content %}{% endblock %}</main>
  </body>
</html>
