{% extends "base.html" %}{% block content %}

<audio
  id="tickSound"
  src="{{ url_for('static', filename='audio/tick.mp3') }}"
  preload="auto"
></audio>

<!-- Dados para a roleta em JSON puro -->
<script type="application/json" id="themesJSON">
  {{ (themes | default([])) | tojson }}
</script>
<script type="application/json" id="finalThemeJSON">
  {{ (theme  | default("") ) | tojson }}
</script>

<!-- ROLETA -->
{% if show_roulette %}
<div id="roulette-overlay">
  <div class="roulette-card">
    <div class="roulette-title">Sorteando tema…</div>
    <div class="roulette-display" id="rouletteDisplay">—</div>
  </div>
</div>
{% endif %}

<div id="game-content" {% if show_roulette %}hidden{% endif %}>
  <div
    id="game-root"
    data-feedback="{{ '1' if feedback|default(false) else '0' }}"
  >
    <div class="game-header">
      <p class="muted">Tema: {{ theme }} • Acertos: {{ score }}/30</p>
      <strong id="timer">15</strong>
    </div>

    {% if q.image_url %} {% set imgsrc = q.image_url %}
    <img
      src="{{ imgsrc if imgsrc.startswith('http') else url_for('static', filename=images) }}"
      alt="Imagem da pergunta"
      loading="lazy"
      decoding="async"
      class="img"
    />{% endif %}
    <h2>{{ q.statement }}</h2>

    {% if not feedback %}
    <!-- MODO PERGUNTA -->
    <form id="qform" method="post" action="/answer" class="options">
      <input type="hidden" name="qid" value="{{ q.id }}" />
      <input type="hidden" name="correct" value="{{ q.correct }}" />
      <input type="hidden" name="picked" id="pickedHidden" />
      <button
        class="button opt"
        type="button"
        onclick="return pickAndSubmit('A')"
      >
        {{ q.opt_a }}
      </button>
      <button
        class="button opt"
        type="button"
        onclick="return pickAndSubmit('B')"
      >
        {{ q.opt_b }}
      </button>
      <button
        class="button opt"
        type="button"
        onclick="return pickAndSubmit('C')"
      >
        {{ q.opt_c }}
      </button>
      <button
        class="button opt"
        type="button"
        onclick="return pickAndSubmit('D')"
      >
        {{ q.opt_d }}
      </button>
    </form>

    {% else %}
    <div class="card" id="feedbackBox">
      {% if timed_out %}
      <h3>⏰ Tempo esgotado!</h3>
      {% elif was_correct %}
      <h3>✅ Resposta correta!</h3>
      {% else %}
      <h3>❌ Resposta incorreta</h3>
      {% endif %}

      <form class="feedback-form" method="post" action="/continue">
        {% if was_correct %}
        <input type="hidden" name="last" value="correct" />
        {% else %}
        <input type="hidden" name="last" value="wrong" />
        {% endif %}
        <input
          type="hidden"
          name="last"
          value="{% if timed_out %}timeout{% elif was_correct %}correct{% else %}wrong{% endif %}"
        />
        <button class="button">Continuar</button>
      </form>
    </div>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    const content = document.getElementById("game-content");
    const overlay = document.getElementById("roulette-overlay");
    const root = document.getElementById("game-root");
    const timerEl = document.getElementById("timer");

    // ===== ROLETA =====
    if (overlay) {
      const display = document.getElementById("rouletteDisplay");

      // Lê JSON com segurança
      function parseJSONSafe(elId, fallback) {
        try {
          const el = document.getElementById(elId);
          if (!el) return fallback;
          const txt = (el.textContent || "").trim();
          if (!txt) return fallback;
          return JSON.parse(txt);
        } catch (_) {
          return fallback;
        }
      }

      let themes = parseJSONSafe("themesJSON", []);
      const finalTheme = parseJSONSafe("finalThemeJSON", null);

      // Fallback defensivo (se por algum motivo vier vazio)
      if (!Array.isArray(themes) || themes.length === 0) {
        themes = [
          "Esportes",
          "TV/Cinema",
          "Jogos",
          "Música",
          "Lógica",
          "História",
          "Diversos",
        ];
      }

      // === áudio de tick ===
      const tickAudio = document.getElementById("tickSound");
      function playTick() {
        if (!tickAudio) return;
        try {
          // reinicia e tenta tocar (autoplay pode bloquear em alguns browsers; ignore erro)
          tickAudio.currentTime = 0;
          const p = tickAudio.play();
          if (p && typeof p.catch === "function") p.catch(() => {});
        } catch (_) {}
      }

      // Animação mais rápida/curta
      let idx = 0,
        delay = 28,
        ticks = 0;
      const total = 21; // antes 32, agora bem mais ágil

      function tick() {
        const name = themes[idx % themes.length] || "—";
        display.textContent = name;
        idx++;
        ticks++;

        overlay.setAttribute("data-roulette", name);
        display.classList.remove("swap");
        void display.offsetWidth;
        display.classList.add("swap");

        playTick();

        // desacelera suavemente
        if (ticks > total * 0.66) delay += 40;
        else if (ticks > total * 0.33) delay += 20;
        else delay += 10;

        if (ticks < total) {
          setTimeout(tick, delay);
        } else {
          display.textContent = finalTheme ?? "—";
          overlay.setAttribute("data-roulette", display.textContent);
          // PAUSA maior antes de revelar o conteúdo (ajuste aqui: 1500ms)
          setTimeout(() => {
            overlay.classList.add("hide");
            if (content) {
              content.hidden = false;
              // força um frame para transição
              requestAnimationFrame(() => content.classList.add("show"));
            }
            startQuestionTimer();
          }, 2500);
        }
      }

      setTimeout(() => {
        tick();
      }, 200);
    } else {
      // sem roleta: mostra conteúdo já com fade (se quiser)
      if (content) {
        content.hidden = false;
        requestAnimationFrame(() => content.classList.add("show"));
      }
      startQuestionTimer();
    }

    // ===== LÓGICA DA PERGUNTA (timer + clique) =====
    function startQuestionTimer() {
      if (!root) return;
      const inFeedback = root.dataset.feedback === "1";

      if (inFeedback) {
        if (timerEl) timerEl.textContent = "–";
        return;
      }

      const form = document.getElementById("qform");
      const hidden = document.getElementById("pickedHidden");
      const buttons = document.querySelectorAll(".opt");

      window.pickAndSubmit = function (letter) {
        if (!hidden || !form) return false;
        hidden.value = letter;
        buttons.forEach((b) => (b.disabled = true));
        if (form.requestSubmit) form.requestSubmit();
        else form.submit();
        return false;
      };

      let remaining = 15;
      timerEl.textContent = remaining;
      const interval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(interval);
          if (hidden) hidden.value = "TIMEOUT";
          buttons.forEach((b) => (b.disabled = true));
          if (form) form.requestSubmit ? form.requestSubmit() : form.submit();
        } else {
          timerEl.textContent = remaining;
          if (remaining <= 5) timerEl.style.color = "#ef4444";
        }
      }, 1000);
    }
  })();
</script>

<style>
  :root[data-theme="light"] {
    --roulette-overlay-bg: rgba(255, 255, 255, 0.8);
    --roulette-card-bg: #ffffff;
    --roulette-border: #e5e7eb;
    --roulette-display-bg: #f3f4f6;
    --roulette-title: #0f172a;
    --roulette-text: #0f172a;
    --roulette-accent: #2563eb; /* fallback */
  }
  :root[data-theme="dark"] {
    --roulette-overlay-bg: rgba(0, 0, 0, 0.75);
    --roulette-card-bg: #111827;
    --roulette-border: #1f2937;
    --roulette-display-bg: #0b1220;
    --roulette-title: #a7f3d0;
    --roulette-text: #e5e7eb;
    --roulette-accent: #60a5fa; /* fallback */
  }

  #roulette-overlay[data-roulette="Esportes"] {
    --roulette-accent: #22c55e;
  }
  #roulette-overlay[data-roulette="TV/Cinema"] {
    --roulette-accent: #f59e0b;
  }
  #roulette-overlay[data-roulette="Jogos"] {
    --roulette-accent: #8b5cf6;
  }
  #roulette-overlay[data-roulette="Música"] {
    --roulette-accent: #06b6d4;
  }
  #roulette-overlay[data-roulette="Lógica"] {
    --roulette-accent: #f43f5e;
  }
  #roulette-overlay[data-roulette="História"] {
    --roulette-accent: #eab308;
  }
  #roulette-overlay[data-roulette="Diversos"] {
    --roulette-accent: #3b82f6;
  }

  #roulette-overlay {
    position: fixed;
    inset: 0;
    background: var(--roulette-overlay-bg);
    display: grid;
    place-items: center;
    z-index: 50;
    transition: opacity 0.35s ease;
  }
  #roulette-overlay.hide {
    opacity: 0;
    pointer-events: none;
  }
  .roulette-card {
    background: var(--roulette-card-bg);
    border: 1px solid var(--roulette-border);
    border-radius: 16px;
    padding: 24px;
    width: min(92vw, 520px);
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }
  .roulette-title {
    color: var(--roulette-title);
    font-size: 1.1rem;
    margin-bottom: 20px;
  }
  .roulette-display {
    font-size: clamp(1.6rem, 4vw, 2.4rem);
    font-weight: 800;
    letter-spacing: 0.5px;
    padding: 14px 10px;
    background: var(--roulette-display-bg);
    border: 1px solid var(--roulette-border);
    border-radius: 12px;
    margin-bottom: 8px;
    color: var(--roulette-text);
    box-shadow: 0 0 0 2px
      color-mix(in srgb, var(--roulette-accent) 35%, transparent);
  }

  /* brilho pulsante leve nas trocas */
  .roulette-display.swap {
    animation: glow 0.25s ease;
  }
  @keyframes glow {
    0% {
      box-shadow: 0 0 0 2px
        color-mix(in srgb, var(--roulette-accent) 60%, transparent);
    }
    100% {
      box-shadow: 0 0 0 2px
        color-mix(in srgb, var(--roulette-accent) 35%, transparent);
    }
  }

  .game-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
</style>

{% endblock %}
